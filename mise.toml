# SPDX-FileCopyrightText: 2025 Knitli Inc. <knitli@knit.li>
# SPDX-FileContributor: Adam Poulemanos <adam@knit.li>
#
# SPDX-License-Identifier: MIT OR Apache-2.0

experimental_monorepo_root = true

[tools]
act = "latest"
ast-grep = "latest"
bun = "latest"
cargo-binstall = "latest"
"cargo:cargo-audit" = "latest"
"cargo:cargo-deny" = "latest"
"cargo:cargo-edit" = "latest"
"cargo:cargo-generate" = "latest"
"cargo:cargo-nextest" = "latest"
"cargo:cargo-release" = "latest"
"cargo:cargo-smart-release" = "latest"
"cargo:cargo-watch" = "latest"
gh = "latest"
gitsign = "latest"
hk = "latest"
node = "24"
"npm:wasm-opt" = "latest"
"npm:wasm-pack" = "latest"
"pipx:SuperClaude" = "latest"
"pipx:reuse" = "latest"
pkl = "latest"
ripgrep = "latest"
rust = "latest"
tombi = "latest"
typos = "latest"
uv = "latest"
yq = "latest"

# environment variables for every environment
[env]
MISE_EXPERIMENTAL = 1
CARGO_TARGET_DIR = "target"
HK_MISE = 1

[settings]
idiomatic_version_file_enable_tools = []

[hooks]
enter = '''
echo "Activating environment..."
mise run enter
'''
# deactivate/unhook when you leave
leave = '''eval "$(mise deactivate)" &/dev/null || true
echo "Environment deactivated"
'''

# Tasks are run by using `mise run taskname`, like `mise run build`
# run tasks run as simple shell commands

# ** -------------------- Tool and Setup Tasks --------------------

[tasks.enter]
hide = true  # hide this task from the list
description = "activate the development environment"
silent = true
depends = ["install-tools", "installhooks"]

[tasks.update-tools]
description = "update all dev tools and mise"
run = '''
mise -yq upgrade
mise -yq self-update
'''

[tasks.install-tools]
description = "setup dev tooling and development hooks"
run = '''
mise -yq trust  || true
mise -yq install || true
'''

[tasks.installhooks]
depends = ["install-tools"]
description = "only install development hooks"
run = "hk install --mise &>/dev/null || true"

[tasks.update]
description = "update dependencies"
run = ["cargo update", "cargo update --workspace"]

# ** -------------------- Cleaning Tasks --------------------

[tasks.cleancache]
description = "delete the cache"
run = ["rm -rf .cache", "mise -yq prune || true"]
hide = true  # hide this task from the list

[tasks.clean]
depends = ["cleancache"]
description = "Removes caches and build artifacts."
run = ["cargo clean", "rm -rf crates/thread-wasm/pkg &>/dev/null || true"]

# ** -------------------- Build Tasks --------------------

[tasks.build]
description = "Build everything (except wasm)"
run = "cargo build --workspace"
alias = "b"  # `mise run b` = build

[tasks.build-fast]
tools.rust = "nightly"
description = "Build with cranelift backend for faster debug builds (requires nightly)"
run = """
rustup component add rustc-codegen-cranelift-preview --toolchain nightly 2>/dev/null || true
RUSTFLAGS="-Zcodegen-backend=cranelift" cargo +nightly build --workspace
"""
alias = "bf"

[tasks.build-release]
description = "Build everything in release mode (except wasm)"
run = "cargo build --workspace --release --features inline"
alias = "br"  # `mise run br` = build release

[tasks.build-wasm]
description = "Build WASM target for development"
run = "cargo run -p xtask build-wasm"
alias = "bw"  # `mise run bw` = build wasm

[tasks.build-wasm-browser-dev]
description = "Build WASM target for browser development"  # we don't use the browser target, so currently this is just for testing purposes
run = "cargo run -p xtask build-wasm --multi-threading"
alias = "bwd"  # `mise run bwd` = build wasm browser dev

[tasks.build-wasm-profile]
description = "Build WASM target with profiling"
run = "cargo run -p xtask build-wasm --profiling"
alias = "bwp"  # `mise run bwp` = build wasm profiling

[tasks.build-wasm-browser-profile]
description = "Build WASM target for browser to profile"
run = "cargo run -p xtask build-wasm --profiling --multi-threading"
alias = "bwpd"  # `mise run bwpd` = build wasm browser prod

[tasks.build-wasm-release]
description = "Build WASM target in release mode."
run = "cargo run -p xtask build-wasm --release"
alias = "bwr"  # `mise run bwr` = build wasm release

# ** -------------------- Testing/Linting/Formatting Tasks --------------------

[tasks.update-licenses]
description = "Update license headers for all files"
run = "./scripts/update-licenses.py"

[tasks.test]
description = "Run automated tests"
# multiple commands are run in series
run = "hk run test"
alias = "t"  # `mise run t` = test

[tasks.lint]
description = "Full linting of the codebase"
run = "hk run check"
alias = "c"  # `mise run c` = check

[tasks.fix]
description = "fix formatting and apply lint fixes"
run = "hk fix"
alias = "f"  # `mise run f` = fix

[tasks.ci]  # only dependencies to be run
description = "Run CI tasks"
depends = ["build", "lint", "test"]
